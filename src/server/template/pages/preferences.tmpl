{{define "content"}}
<div class="static-page preferences-page">
    <h1>Preferences</h1>
    <p class="subtitle">Customize your search experience. Settings are saved locally in your browser.</p>

    <div class="preferences-section">
        <h2>General Settings</h2>
        <form id="general-settings" class="preferences-form">
            <div class="form-group">
                <label for="theme">Theme</label>
                <select id="theme" name="theme">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                    <option value="system">System Default</option>
                </select>
            </div>

            <div class="form-group">
                <label for="safe-search">Safe Search</label>
                <select id="safe-search" name="safe_search">
                    <option value="0">Off</option>
                    <option value="1" selected>Moderate</option>
                    <option value="2">Strict</option>
                </select>
            </div>

            <div class="form-group">
                <label for="results-per-page">Results Per Page</label>
                <select id="results-per-page" name="results_per_page">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                </select>
            </div>

            <div class="form-group">
                <label for="new-tab">Open Results in New Tab</label>
                <input type="checkbox" id="new-tab" name="new_tab">
            </div>
        </form>
    </div>

    <div class="preferences-section">
        <h2>Search Bangs</h2>
        <p class="help-text">
            Bangs let you search other sites directly. Type <code>!g</code> before your search to use Google,
            <code>!w</code> for Wikipedia, <code>!yt</code> for YouTube, and many more.
        </p>

        <div class="bang-categories">
            <h3>Available Bangs</h3>
            <div class="category-filter">
                <button class="filter-btn active" data-category="all">All</button>
                {{range .Data.categories}}
                <button class="filter-btn" data-category="{{.}}">{{. | title}}</button>
                {{end}}
            </div>

            <div class="bang-list" id="bang-list">
                {{range .Data.bangs}}
                <div class="bang-item" data-category="{{.Category}}">
                    <span class="bang-shortcut">!{{.Shortcut}}</span>
                    <span class="bang-name">{{.Name}}</span>
                    {{if .Description}}
                    <span class="bang-description">{{.Description}}</span>
                    {{end}}
                </div>
                {{end}}
            </div>
        </div>
    </div>

    <div class="preferences-section">
        <h2>Homepage Widgets</h2>
        <p class="help-text">Enable widgets to display on the homepage. These let you access useful information at a glance.</p>

        <div class="widget-toggles" id="widget-toggles">
            <div class="widget-category">
                <h3>Tool Widgets</h3>
                <div class="widget-toggle-group">
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="clock" checked>
                        <span class="widget-icon">üïê</span>
                        <span class="widget-name">Clock</span>
                    </label>
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="calculator">
                        <span class="widget-icon">üî¢</span>
                        <span class="widget-name">Calculator</span>
                    </label>
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="calendar">
                        <span class="widget-icon">üìÖ</span>
                        <span class="widget-name">Calendar</span>
                    </label>
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="converter">
                        <span class="widget-icon">üîÑ</span>
                        <span class="widget-name">Unit Converter</span>
                    </label>
                </div>
            </div>

            <div class="widget-category">
                <h3>Data Widgets</h3>
                <div class="widget-toggle-group">
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="weather">
                        <span class="widget-icon">üå§Ô∏è</span>
                        <span class="widget-name">Weather</span>
                    </label>
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="news">
                        <span class="widget-icon">üì∞</span>
                        <span class="widget-name">News</span>
                    </label>
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="stocks">
                        <span class="widget-icon">üìà</span>
                        <span class="widget-name">Stocks</span>
                    </label>
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="crypto">
                        <span class="widget-icon">üí∞</span>
                        <span class="widget-name">Crypto</span>
                    </label>
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="sports">
                        <span class="widget-icon">‚öΩ</span>
                        <span class="widget-name">Sports</span>
                    </label>
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="rss">
                        <span class="widget-icon">üì°</span>
                        <span class="widget-name">RSS Feeds</span>
                    </label>
                </div>
            </div>

            <div class="widget-category">
                <h3>User Widgets</h3>
                <div class="widget-toggle-group">
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="quicklinks">
                        <span class="widget-icon">üîó</span>
                        <span class="widget-name">Quick Links</span>
                    </label>
                    <label class="widget-toggle">
                        <input type="checkbox" data-widget="notes">
                        <span class="widget-icon">üìù</span>
                        <span class="widget-name">Notes</span>
                    </label>
                </div>
            </div>
        </div>

        <p class="help-text mt-1">
            Tip: You can also configure individual widget settings by clicking the gear icon on each widget on the homepage.
        </p>
    </div>

    <div class="preferences-section">
        <h2>Custom Bangs</h2>
        <p class="help-text">Create your own bang shortcuts. These are saved in your browser.</p>

        <div id="custom-bangs-list" class="custom-bangs-list">
            <!-- Custom bangs will be populated by JavaScript -->
        </div>

        <form id="add-custom-bang" class="add-bang-form">
            <h3>Add Custom Bang</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="bang-shortcut">Shortcut</label>
                    <input type="text" id="bang-shortcut" name="shortcut" placeholder="e.g., mysite" required pattern="[a-zA-Z0-9_-]+">
                </div>
                <div class="form-group">
                    <label for="bang-name">Name</label>
                    <input type="text" id="bang-name" name="name" placeholder="e.g., My Favorite Site" required>
                </div>
            </div>
            <div class="form-group">
                <label for="bang-url">URL Template</label>
                <input type="url" id="bang-url" name="url" placeholder="https://example.com/search?q={query}" required>
                <small>Use <code>{query}</code> as placeholder for the search term</small>
            </div>
            <div class="form-group">
                <label for="bang-category">Category</label>
                <input type="text" id="bang-category" name="category" placeholder="e.g., custom" value="custom">
            </div>
            <button type="submit" class="btn btn-primary">Add Bang</button>
        </form>
    </div>

    <div class="preferences-section">
        <h2>Add to Browser</h2>
        <p class="help-text">Add this search engine to your browser's search bar.</p>

        <div class="browser-add">
            <p>
                Most browsers support adding custom search engines. Look for the search bar settings
                in your browser preferences, or right-click on the search box on the homepage.
            </p>
            <p>
                <strong>OpenSearch URL:</strong>
                <code id="opensearch-url">{{.Config.Server.BaseURL}}/opensearch.xml</code>
            </p>
            <div class="form-group">
                <label for="custom-engine-name">Custom Engine Name (optional)</label>
                <input type="text" id="custom-engine-name" placeholder="{{.Config.Server.Title}}">
                <button type="button" id="copy-opensearch" class="btn btn-secondary">Copy OpenSearch URL</button>
            </div>
        </div>
    </div>

    <div class="preferences-section">
        <h2>Data Management</h2>
        <div class="data-actions">
            <button type="button" id="export-prefs" class="btn btn-secondary">Export Preferences</button>
            <button type="button" id="import-prefs" class="btn btn-secondary">Import Preferences</button>
            <button type="button" id="reset-prefs" class="btn btn-danger">Reset All Preferences</button>
        </div>
        <input type="file" id="import-file" accept=".json" class="hidden">
    </div>

    <div class="preferences-actions">
        <button type="button" id="save-preferences" class="btn btn-primary">Save Preferences</button>
        <span id="save-status" class="save-status"></span>
    </div>
</div>

<style>
.preferences-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
}

.subtitle {
    color: var(--text-muted);
    margin-bottom: 2rem;
}

.preferences-section {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.preferences-section h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.5rem;
}

.help-text {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.form-group input[type="text"],
.form-group input[type="url"],
.form-group select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
}

.form-group input[type="checkbox"] {
    width: auto;
}

.form-group small {
    display: block;
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.form-row {
    display: flex;
    gap: 1rem;
}

.form-row .form-group {
    flex: 1;
}

.category-filter {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.filter-btn {
    padding: 0.25rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 0.85rem;
}

.filter-btn:hover,
.filter-btn.active {
    background: var(--accent-color);
    color: var(--bg-primary);
    border-color: var(--accent-color);
}

.bang-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 0.75rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
}

.bang-item {
    background: var(--bg-primary);
    padding: 0.75rem;
    border-radius: 4px;
    border: 1px solid var(--border-color);
}

.bang-item.hidden {
    display: none;
}

.bang-shortcut {
    font-family: monospace;
    font-weight: bold;
    color: var(--accent-color);
    margin-right: 0.5rem;
}

.bang-name {
    font-weight: 500;
}

.bang-description {
    display: block;
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.custom-bangs-list {
    margin-bottom: 1rem;
}

.custom-bang-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.custom-bang-item .bang-info {
    flex: 1;
}

.custom-bang-item .delete-btn {
    background: var(--danger-color);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    cursor: pointer;
}

.add-bang-form {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.add-bang-form h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1rem;
}

.browser-add code {
    display: block;
    background: var(--bg-primary);
    padding: 0.5rem;
    border-radius: 4px;
    margin: 0.5rem 0;
    word-break: break-all;
}

.data-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-primary {
    background: var(--accent-color);
    color: var(--bg-primary);
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

.preferences-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
}

.save-status {
    color: var(--success-color);
}

/* Widget toggles */
.widget-toggles {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.widget-category h3 {
    font-size: 0.95rem;
    margin-bottom: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.widget-toggle-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 0.75rem;
}

.widget-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
}

.widget-toggle:hover {
    border-color: var(--accent-color);
}

.widget-toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.widget-toggle input[type="checkbox"]:checked + .widget-icon,
.widget-toggle input[type="checkbox"]:checked ~ .widget-name {
    opacity: 1;
}

.widget-toggle .widget-icon {
    font-size: 1.2rem;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.widget-toggle .widget-name {
    font-size: 0.9rem;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.widget-toggle:has(input:checked) {
    border-color: var(--accent-color);
    background: rgba(var(--accent-rgb), 0.05);
}

.widget-toggle:has(input:checked) .widget-icon,
.widget-toggle:has(input:checked) .widget-name {
    opacity: 1;
}

@media (max-width: 600px) {
    .form-row {
        flex-direction: column;
    }

    .bang-list {
        grid-template-columns: 1fr;
    }

    .data-actions {
        flex-direction: column;
    }
}
</style>

<script>
(function() {
    // Storage keys
    const PREFS_KEY = 'search_preferences';
    const BANGS_KEY = 'search_custom_bangs';
    const WIDGETS_KEY = 'search_widgets';

    // Load preferences from localStorage
    function loadPreferences() {
        try {
            const prefs = JSON.parse(localStorage.getItem(PREFS_KEY) || '{}');

            // Apply general settings
            if (prefs.theme) document.getElementById('theme').value = prefs.theme;
            if (prefs.safe_search !== undefined) document.getElementById('safe-search').value = prefs.safe_search;
            if (prefs.results_per_page) document.getElementById('results-per-page').value = prefs.results_per_page;
            if (prefs.new_tab) document.getElementById('new-tab').checked = prefs.new_tab;

            // Per AI.md PART 16: Apply theme class to <html> element
            if (prefs.theme && prefs.theme !== 'system') {
                document.documentElement.classList.remove('theme-dark', 'theme-light');
                document.documentElement.classList.add('theme-' + prefs.theme);
            }
        } catch (e) {
            console.error('Failed to load preferences:', e);
        }
    }

    // Save preferences to localStorage
    function savePreferences() {
        const prefs = {
            theme: document.getElementById('theme').value,
            safe_search: document.getElementById('safe-search').value,
            results_per_page: document.getElementById('results-per-page').value,
            new_tab: document.getElementById('new-tab').checked
        };

        localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));

        // Per AI.md PART 16: Apply theme class to <html> element immediately
        if (prefs.theme !== 'system') {
            document.documentElement.classList.remove('theme-dark', 'theme-light');
            document.documentElement.classList.add('theme-' + prefs.theme);
        }

        // Save widget preferences too
        saveWidgetPreferences();

        showStatus('Preferences saved!');
    }

    // Load widget preferences
    function loadWidgetPreferences() {
        try {
            const widgets = JSON.parse(localStorage.getItem(WIDGETS_KEY) || '[]');

            // Update checkboxes based on saved state
            document.querySelectorAll('.widget-toggle input[type="checkbox"]').forEach(checkbox => {
                const widgetType = checkbox.dataset.widget;
                // If no saved preferences, use default checked state from HTML
                if (widgets.length > 0) {
                    checkbox.checked = widgets.includes(widgetType);
                }
            });
        } catch (e) {
            console.error('Failed to load widget preferences:', e);
        }
    }

    // Save widget preferences
    function saveWidgetPreferences() {
        const enabledWidgets = [];
        document.querySelectorAll('.widget-toggle input[type="checkbox"]:checked').forEach(checkbox => {
            enabledWidgets.push(checkbox.dataset.widget);
        });
        localStorage.setItem(WIDGETS_KEY, JSON.stringify(enabledWidgets));
    }

    // Load custom bangs
    function loadCustomBangs() {
        try {
            const bangs = JSON.parse(localStorage.getItem(BANGS_KEY) || '[]');
            renderCustomBangs(bangs);
        } catch (e) {
            console.error('Failed to load custom bangs:', e);
        }
    }

    // Save custom bangs
    function saveCustomBangs(bangs) {
        localStorage.setItem(BANGS_KEY, JSON.stringify(bangs));
    }

    // Render custom bangs list
    function renderCustomBangs(bangs) {
        const list = document.getElementById('custom-bangs-list');
        list.innerHTML = '';

        if (bangs.length === 0) {
            list.innerHTML = '<p class="help-text">No custom bangs defined.</p>';
            return;
        }

        bangs.forEach((bang, index) => {
            const item = document.createElement('div');
            item.className = 'custom-bang-item';
            item.innerHTML = `
                <div class="bang-info">
                    <span class="bang-shortcut">!${escapeHtml(bang.shortcut)}</span>
                    <span class="bang-name">${escapeHtml(bang.name)}</span>
                </div>
                <button class="delete-btn" data-index="${index}">Delete</button>
            `;
            list.appendChild(item);
        });

        // Add delete handlers
        list.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const idx = parseInt(this.dataset.index);
                const bangs = JSON.parse(localStorage.getItem(BANGS_KEY) || '[]');
                bangs.splice(idx, 1);
                saveCustomBangs(bangs);
                renderCustomBangs(bangs);
                showStatus('Bang deleted');
            });
        });
    }

    // Add custom bang
    function addCustomBang(e) {
        e.preventDefault();

        const shortcut = document.getElementById('bang-shortcut').value.toLowerCase().replace(/[^a-z0-9_-]/g, '');
        const name = document.getElementById('bang-name').value;
        const url = document.getElementById('bang-url').value;
        const category = document.getElementById('bang-category').value || 'custom';

        if (!shortcut || !name || !url) {
            showStatus('Please fill in all required fields', true);
            return;
        }

        const bangs = JSON.parse(localStorage.getItem(BANGS_KEY) || '[]');

        // Check for duplicates
        if (bangs.some(b => b.shortcut === shortcut)) {
            showStatus('A bang with this shortcut already exists', true);
            return;
        }

        bangs.push({
            shortcut: shortcut,
            name: name,
            url: url,
            category: category,
            enabled: true
        });

        saveCustomBangs(bangs);
        renderCustomBangs(bangs);

        // Reset form
        e.target.reset();
        document.getElementById('bang-category').value = 'custom';

        showStatus('Custom bang added!');
    }

    // Filter bangs by category
    function filterBangs(category) {
        const items = document.querySelectorAll('.bang-item');
        items.forEach(item => {
            if (category === 'all' || item.dataset.category === category) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }

    // Copy OpenSearch URL
    function copyOpenSearchURL() {
        const customName = document.getElementById('custom-engine-name').value;
        let url = window.location.origin + '/opensearch.xml';
        if (customName) {
            url += '?name=' + encodeURIComponent(customName);
        }

        navigator.clipboard.writeText(url).then(() => {
            showStatus('OpenSearch URL copied!');
        }).catch(() => {
            // Fallback
            document.getElementById('opensearch-url').textContent = url;
            showStatus('URL updated above - copy manually');
        });
    }

    // Export preferences
    function exportPreferences() {
        const data = {
            preferences: JSON.parse(localStorage.getItem(PREFS_KEY) || '{}'),
            custom_bangs: JSON.parse(localStorage.getItem(BANGS_KEY) || '[]'),
            widgets: JSON.parse(localStorage.getItem(WIDGETS_KEY) || '[]'),
            exported_at: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'search-preferences.json';
        a.click();
        URL.revokeObjectURL(url);

        showStatus('Preferences exported!');
    }

    // Import preferences
    function importPreferences(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);

                if (data.preferences) {
                    localStorage.setItem(PREFS_KEY, JSON.stringify(data.preferences));
                }
                if (data.custom_bangs) {
                    localStorage.setItem(BANGS_KEY, JSON.stringify(data.custom_bangs));
                }
                if (data.widgets) {
                    localStorage.setItem(WIDGETS_KEY, JSON.stringify(data.widgets));
                }

                loadPreferences();
                loadCustomBangs();
                loadWidgetPreferences();
                showStatus('Preferences imported!');
            } catch (err) {
                showStatus('Failed to import preferences', true);
            }
        };
        reader.readAsText(file);
    }

    // Reset preferences
    async function resetPreferences() {
        // Use custom confirm instead of JavaScript confirm()
        // Per AI.md PART 16: NO JavaScript alerts
        const confirmed = await showConfirm('Are you sure you want to reset all preferences?', 'Reset Preferences');
        if (!confirmed) return;

        localStorage.removeItem(PREFS_KEY);
        localStorage.removeItem(BANGS_KEY);
        localStorage.removeItem(WIDGETS_KEY);

        // Also clear individual widget settings
        const widgetSettingsKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('search_widget_')) {
                widgetSettingsKeys.push(key);
            }
        }
        widgetSettingsKeys.forEach(key => localStorage.removeItem(key));

        location.reload();
    }

    // Show status message
    function showStatus(message, isError) {
        const status = document.getElementById('save-status');
        status.textContent = message;
        status.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';

        setTimeout(() => {
            status.textContent = '';
        }, 3000);
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadPreferences();
        loadCustomBangs();
        loadWidgetPreferences();

        // Event listeners
        document.getElementById('save-preferences').addEventListener('click', savePreferences);

        // Widget toggles - save on change
        document.querySelectorAll('.widget-toggle input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', saveWidgetPreferences);
        });
        document.getElementById('add-custom-bang').addEventListener('submit', addCustomBang);
        document.getElementById('copy-opensearch').addEventListener('click', copyOpenSearchURL);
        document.getElementById('export-prefs').addEventListener('click', exportPreferences);
        document.getElementById('import-prefs').addEventListener('click', () => document.getElementById('import-file').click());
        document.getElementById('import-file').addEventListener('change', importPreferences);
        document.getElementById('reset-prefs').addEventListener('click', resetPreferences);

        // Category filter
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                filterBangs(this.dataset.category);
            });
        });

        // Update OpenSearch URL on custom name change
        document.getElementById('custom-engine-name').addEventListener('input', function() {
            let url = window.location.origin + '/opensearch.xml';
            if (this.value) {
                url += '?name=' + encodeURIComponent(this.value);
            }
            document.getElementById('opensearch-url').textContent = url;
        });
    });
})();
</script>
{{end}}
